<!DOCTYPE html>
<html>
  <head>
     
    <meta charset="UTF-8">
    <title>FFplay源码分析---audio_thread() - 木偶人</title>
    <link rel="shortcut icon" href="/static/img/icon.png">
    <link rel="icon" href="/static/img/icon.png" sizes="192x192"/>
    
<link rel="stylesheet" href="/static/kico.css">
<link rel="stylesheet" href="/static/hingle.css">

    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1"/>
    <meta property="og:site_name" content="木偶人">
    <meta property="og:title" content="FFplay源码分析---audio_thread()"/>
    
    <style>body:before{ content: ''; background-image: url(https://api.paugram.com/wallpaper?source=gh) }</style>
    
<meta name="generator" content="Hexo 6.3.0"></head>

  <body>
    <header>
    <div class="head-title">
        <h4>木偶人</h4>
    </div>
    <div class="head-action">
        <div class="toggle-btn"></div>
        <div class="light-btn"></div>
        <div class="search-btn"></div>
    </div>
    <form class="head-search" method="post">
        <input type="text" name="s" placeholder="搜索什么？">
    </form>
    <nav class="head-menu">
        <a href="/">首页</a>
        <div class="has-child">
            <a>分类</a>
            <div class="sub-menu">
                <a class="category-link" href="/categories/FFmpeg/">FFmpeg</a><a class="category-link" href="/categories/c/">c++</a><a class="category-link" href="/categories/sylar/">sylar</a>
            </div>
        </div>
        
            <a href="/about">关于我</a>
        
            <a href="/friends">朋友们</a>
        
    </nav>
</header>

    <main>
    <div class="wrap min">
        <section class="post-title">
            <h2>FFplay源码分析---audio_thread()</h2>
            <div class="post-meta">
                <time class="date">2023.12.12</time>
            
            </div>
        </section>
        <article class="post-content">
        
            <h2 id="audio-thread"><a href="#audio-thread" class="headerlink" title="audio_thread()"></a>audio_thread()</h2><p><img src="/../../../images/FFmpeg/ffplay%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/audio_thread().png" alt="Alt text"><br>在 stream_component_open() 里面的 decode_start() 函数开启了 audio_thread 线程，如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">decoder_start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>is<span class="token operator">-></span>auddec<span class="token punctuation">,</span> audio_thread<span class="token punctuation">,</span> <span class="token string">"audio_decoder"</span><span class="token punctuation">,</span> is<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">goto</span> out<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>audio_thread 线程主要是负责 解码 PacketQueue 队列里面的 AVPacket 的，解码出来 AVFrame，然后丢给入口滤镜，再从出口滤镜把 AVFrame 读出来，再插入 FrameQueue 队列。</p>
<p>流程图如下:<br><img src="/../../../images/FFmpeg/ffplay%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/audio_open%E6%B5%81%E7%A8%8B.png" alt="Alt text"></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">audio_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    VideoState <span class="token operator">*</span>is <span class="token operator">=</span> arg<span class="token punctuation">;</span>
    AVFrame <span class="token operator">*</span>frame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Frame <span class="token operator">*</span>af<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CONFIG_AVFILTER</span></span>
    <span class="token keyword">int</span> last_serial <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int64_t</span> dec_channel_layout<span class="token punctuation">;</span>
    <span class="token keyword">int</span> reconfigure<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">int</span> got_frame <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    AVRational tb<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>frame<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>got_frame <span class="token operator">=</span> <span class="token function">decoder_decode_frame</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>is<span class="token operator">-></span>auddec<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> the_end<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>got_frame<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                tb <span class="token operator">=</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> frame<span class="token operator">-></span>sample_rate<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CONFIG_AVFILTER</span></span>
                dec_channel_layout <span class="token operator">=</span> <span class="token function">get_valid_channel_layout</span><span class="token punctuation">(</span>frame<span class="token operator">-></span>channel_layout<span class="token punctuation">,</span> frame<span class="token operator">-></span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>

                reconfigure <span class="token operator">=</span>
                    <span class="token function">cmp_audio_fmts</span><span class="token punctuation">(</span>is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>fmt<span class="token punctuation">,</span> is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>channels<span class="token punctuation">,</span>
                                   frame<span class="token operator">-></span>format<span class="token punctuation">,</span> frame<span class="token operator">-></span>channels<span class="token punctuation">)</span>    <span class="token operator">||</span>
                    is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>channel_layout <span class="token operator">!=</span> dec_channel_layout <span class="token operator">||</span>
                    is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>freq           <span class="token operator">!=</span> frame<span class="token operator">-></span>sample_rate <span class="token operator">||</span>
                    is<span class="token operator">-></span>auddec<span class="token punctuation">.</span>pkt_serial               <span class="token operator">!=</span> last_serial<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>reconfigure<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">char</span> buf1<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf2<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token function">av_get_channel_layout_string</span><span class="token punctuation">(</span>buf1<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>channel_layout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">av_get_channel_layout_string</span><span class="token punctuation">(</span>buf2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> dec_channel_layout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span>
                           <span class="token string">"Audio frame changed from rate:%d ch:%d fmt:%s layout:%s serial:%d to rate:%d ch:%d fmt:%s layout:%s serial:%d\n"</span><span class="token punctuation">,</span>
                           is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>freq<span class="token punctuation">,</span> is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>channels<span class="token punctuation">,</span> <span class="token function">av_get_sample_fmt_name</span><span class="token punctuation">(</span>is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>fmt<span class="token punctuation">)</span><span class="token punctuation">,</span> buf1<span class="token punctuation">,</span> last_serial<span class="token punctuation">,</span>
                           frame<span class="token operator">-></span>sample_rate<span class="token punctuation">,</span> frame<span class="token operator">-></span>channels<span class="token punctuation">,</span> <span class="token function">av_get_sample_fmt_name</span><span class="token punctuation">(</span>frame<span class="token operator">-></span>format<span class="token punctuation">)</span><span class="token punctuation">,</span> buf2<span class="token punctuation">,</span> is<span class="token operator">-></span>auddec<span class="token punctuation">.</span>pkt_serial<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>fmt            <span class="token operator">=</span> frame<span class="token operator">-></span>format<span class="token punctuation">;</span>
                    is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>channels       <span class="token operator">=</span> frame<span class="token operator">-></span>channels<span class="token punctuation">;</span>
                    is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>channel_layout <span class="token operator">=</span> dec_channel_layout<span class="token punctuation">;</span>
                    is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>freq           <span class="token operator">=</span> frame<span class="token operator">-></span>sample_rate<span class="token punctuation">;</span>
                    last_serial                         <span class="token operator">=</span> is<span class="token operator">-></span>auddec<span class="token punctuation">.</span>pkt_serial<span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">configure_audio_filters</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span> afilters<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token keyword">goto</span> the_end<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">av_buffersrc_add_frame</span><span class="token punctuation">(</span>is<span class="token operator">-></span>in_audio_filter<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> the_end<span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">av_buffersink_get_frame_flags</span><span class="token punctuation">(</span>is<span class="token operator">-></span>out_audio_filter<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                tb <span class="token operator">=</span> <span class="token function">av_buffersink_get_time_base</span><span class="token punctuation">(</span>is<span class="token operator">-></span>out_audio_filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>af <span class="token operator">=</span> <span class="token function">frame_queue_peek_writable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>is<span class="token operator">-></span>sampq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">goto</span> the_end<span class="token punctuation">;</span>

                af<span class="token operator">-></span>pts <span class="token operator">=</span> <span class="token punctuation">(</span>frame<span class="token operator">-></span>pts <span class="token operator">==</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token operator">?</span> NAN <span class="token operator">:</span> frame<span class="token operator">-></span>pts <span class="token operator">*</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>tb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                af<span class="token operator">-></span>pos <span class="token operator">=</span> frame<span class="token operator">-></span>pkt_pos<span class="token punctuation">;</span>
                af<span class="token operator">-></span>serial <span class="token operator">=</span> is<span class="token operator">-></span>auddec<span class="token punctuation">.</span>pkt_serial<span class="token punctuation">;</span>
                af<span class="token operator">-></span>duration <span class="token operator">=</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span><span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>frame<span class="token operator">-></span>nb_samples<span class="token punctuation">,</span> frame<span class="token operator">-></span>sample_rate<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">av_frame_move_ref</span><span class="token punctuation">(</span>af<span class="token operator">-></span>frame<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">frame_queue_push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>is<span class="token operator">-></span>sampq<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CONFIG_AVFILTER</span></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token operator">-></span>audioq<span class="token punctuation">.</span>serial <span class="token operator">!=</span> is<span class="token operator">-></span>auddec<span class="token punctuation">.</span>pkt_serial<span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> AVERROR_EOF<span class="token punctuation">)</span>
                is<span class="token operator">-></span>auddec<span class="token punctuation">.</span>finished <span class="token operator">=</span> is<span class="token operator">-></span>auddec<span class="token punctuation">.</span>pkt_serial<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">||</span> ret <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span> <span class="token operator">||</span> ret <span class="token operator">==</span> AVERROR_EOF<span class="token punctuation">)</span><span class="token punctuation">;</span>
 the_end<span class="token operator">:</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CONFIG_AVFILTER</span></span>
    <span class="token function">avfilter_graph_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>is<span class="token operator">-></span>agraph<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li><code>audio_thread</code> 函数一开始就进入 一个 <code>do&#123;...&#125;while&#123;...&#125;</code> ，不断地调<code>decoder_decode_frame()</code>函数来解码出 <code>AVFrame</code></li>
<li>然后把 <code>AVFrame</code> 往 入口滤镜(<code>av_buffersrc_add_frame</code>) 丢，再循环调<code>av_buffersink_get_frame_flags()</code>，不断从出口滤镜收割经过 <code>Filter</code> 的<code>AVFrame</code></li>
<li>最后调<code>frame_queue_push()</code>把 <code>AVFrame</code> 插入 <code>FrameQueue</code> 队列。</li>
<li>但是如果解码出来的 <code>AVFrame</code> 的音频格式与入口滤镜要求的音频格式不一样，会重建滤镜（reconfigure），如下：</li>
</ol>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">reconfigure <span class="token operator">=</span>
    <span class="token function">cmp_audio_fmts</span><span class="token punctuation">(</span>is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>fmt<span class="token punctuation">,</span> is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>channels<span class="token punctuation">,</span>
                    frame<span class="token operator">-></span>format<span class="token punctuation">,</span> frame<span class="token operator">-></span>channels<span class="token punctuation">)</span>    <span class="token operator">||</span>
    is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>channel_layout <span class="token operator">!=</span> dec_channel_layout <span class="token operator">||</span>
    is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>freq           <span class="token operator">!=</span> frame<span class="token operator">-></span>sample_rate <span class="token operator">||</span>
    is<span class="token operator">-></span>auddec<span class="token punctuation">.</span>pkt_serial               <span class="token operator">!=</span> last_serial<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>开始的入口滤镜 <code>audio_filter_src</code>的音频格式 是直接从解码器实例（avctx）里面取的，如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 从解码器出来的音频信息,ffplay.c 2648行</span>
is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>freq           <span class="token operator">=</span> avctx<span class="token operator">-></span>sample_rate<span class="token punctuation">;</span>
is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>channels       <span class="token operator">=</span> avctx<span class="token operator">-></span>channels<span class="token punctuation">;</span>
is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>channel_layout <span class="token operator">=</span> <span class="token function">get_valid_channel_layout</span><span class="token punctuation">(</span>avctx<span class="token operator">-></span>channel_layout<span class="token punctuation">,</span> avctx<span class="token operator">-></span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
is<span class="token operator">-></span>audio_filter_src<span class="token punctuation">.</span>fmt            <span class="token operator">=</span> avctx<span class="token operator">-></span>sample_fmt<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而解码器实例<code>avctx</code>的音频信息又是从 容器层的流信息里面取出来的。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">ffpaly<span class="token punctuation">.</span>c <span class="token number">2592</span> 行
ret <span class="token operator">=</span> <span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> ic<span class="token operator">-></span>streams<span class="token punctuation">[</span>stream_index<span class="token punctuation">]</span><span class="token operator">-></span>codecpar<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>所以以下 3 种场景会重新创建滤镜：</p>
<ol>
<li><p>容器层记录的采样率等信息是错误的，与实际解码出来的不符。</p>
</li>
<li><p>解码过程中，中途解码出来的 <code>AVFrame</code> 的采样率，声道数或者采样格式 出现变动，与上一次解码出来的 <code>AVFrame</code> 不一样。</p>
</li>
<li><p>进行了快进快退操作，因为快进快退会导致 <code>is-&gt;auddec.pkt_serial</code> 递增。todo — FFplay序列号分. 。我也不知道为什么序列号变了要重建滤镜。</p>
</li>
<li></li>
</ol>
<p>这3种情况，<code>ffplay</code>都会处理，只要解码出来的 <code>AVFrame</code> 跟入口滤镜的格式不一致，都会重建滤镜，把入口滤镜的格式设置为当前的 <code>AVFrame</code>的格式，这样滤镜处理才不会出错。</p>
<blockquote>
<p>补充：last_serial 变量一开始是 -1，而 is-&gt;auddec.pkt_serial 一开始是 0，所以一开始是必然会执行一次 reconfigure 操作。</p>
</blockquote>
<p>由于每次读取出口滤镜的数据，都会用 while 循环把缓存刷完，不会留数据在滤镜容器里面，所以重建滤镜不会导致音频数据丢失。我圈一下代码里面的重点，如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">av_buffersink_get_frame_flags</span><span class="token punctuation">(</span>is<span class="token operator">-></span>out_audio_filter<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          tb <span class="token operator">=</span> <span class="token function">av_buffersink_get_time_base</span><span class="token punctuation">(</span>is<span class="token operator">-></span>out_audio_filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>af <span class="token operator">=</span> <span class="token function">frame_queue_peek_writable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>is<span class="token operator">-></span>sampq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token keyword">goto</span> the_end<span class="token punctuation">;</span>

          af<span class="token operator">-></span>pts <span class="token operator">=</span> <span class="token punctuation">(</span>frame<span class="token operator">-></span>pts <span class="token operator">==</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token operator">?</span> NAN <span class="token operator">:</span> frame<span class="token operator">-></span>pts <span class="token operator">*</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>tb<span class="token punctuation">)</span><span class="token punctuation">;</span>
          af<span class="token operator">-></span>pos <span class="token operator">=</span> frame<span class="token operator">-></span>pkt_pos<span class="token punctuation">;</span>
          af<span class="token operator">-></span>serial <span class="token operator">=</span> is<span class="token operator">-></span>auddec<span class="token punctuation">.</span>pkt_serial<span class="token punctuation">;</span>
          af<span class="token operator">-></span>duration <span class="token operator">=</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span><span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>frame<span class="token operator">-></span>nb_samples<span class="token punctuation">,</span> frame<span class="token operator">-></span>sample_rate<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token function">av_frame_move_ref</span><span class="token punctuation">(</span>af<span class="token operator">-></span>frame<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">frame_queue_push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>is<span class="token operator">-></span>sampq<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CONFIG_AVFILTER</span></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token operator">-></span>audioq<span class="token punctuation">.</span>serial <span class="token operator">!=</span> is<span class="token operator">-></span>auddec<span class="token punctuation">.</span>pkt_serial<span class="token punctuation">)</span>
              <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p>audio_thread 线程的逻辑比较简单，复杂的地方都封装在它调用的子函数里面，所以本文简单讲解一下，audio_thread() 里面调用的各个函数的作用。</p>
<ol>
<li><p>decoder_decode_frame()，从 PacketQueue 里面解码出来 AVFrame，此函数会阻塞，直到解码出来 AVFrame，或者返回错误。这个函数有 3 个返回值。</p>
<ul>
<li>返回 1，获取到 AVFrame 。</li>
<li>返回 0 ，获取不到 AVFrame ，0 代表已经解码完MP4的所有AVPacket。这种情况一般是 ffplay 播放完了整个 MP4 文件，窗口画面停在最后一帧。但是由于你可以按 C 键重新循环播放，所以即便返回 0 也不能退出 audio_thread 线程。</li>
<li>返回 -1，代表 PacketQueue 队列关闭了（abort_request）。返回 -1 会导致 audio_thread() 函数用 goto the_end 跳出 do{}whlle{} 循环，跳出循环之后，audio_thread 线程就会自己结束了。返回 -1 通常是因为关闭了 ffplay 播放器。</li>
</ul>
</li>
<li><p>configure_audio_filters()，创建音频滤镜函数，之前已经讲过此函数。</p>
</li>
<li><p>av_buffersrc_add_frame()，往入口滤镜发送 AVFrame。</p>
</li>
<li><p>av_buffersink_get_frame_flags()，从出口滤镜读取 AVFrame。</p>
</li>
<li><p>frame_queue_peek_writable()，从 FrameQueue 里面取一个可以写的 Frame 出来。此函数也可能会阻塞。</p>
</li>
<li><p>frame_queue_push()，这个函数有点奇怪，他其实不是把之前的 Frame 塞进去队列，而是把队列的写索引值 +1。<br> todo</p>
</li>
</ol>
<hr>
<p>audio_thread() 函数最后还有一个重点，就是当 出口滤镜 结束的时候，finished 就会设置为 非 0 。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> AVERROR_EOF<span class="token punctuation">)</span>
    is<span class="token operator">-></span>auddec<span class="token punctuation">.</span>finished <span class="token operator">=</span> is<span class="token operator">-></span>auddec<span class="token punctuation">.</span>pkt_serial<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>提示：只有往入口滤镜发送了 NULL 的 AVFrame ，出口滤镜才会结束。读完数据 跟 结束是两种状态，读完代表滤镜暂时没有数据可读，但是只要再往入口滤镜 发 AVFrame，出口滤镜就会又有数据可读。<br>而结束，代表不会再有 AVFrame 往入口滤镜发。</p>

        </article>
        <section class="post-near">
            <ul>
                
                    <li>上一篇: <a href="/2023/12/12/FFmpeg/ffplay%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/decoder-decode-frame/">FFplay源码分析---decoder_decode_frame()</a></li>
                
                
                    <li>下一篇: <a href="/2023/12/11/FFmpeg/ffplay%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/audio-open/">FFplay源码分析---audio_open()</a></li>
                
            </ul>
        </section>
        
            <section class="post-tags">
            <a class="-none-link" href="/tags/FFplay%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">FFplay源码分析</a>
            </section>
        
    
        <section class="post-author">
        
            <figure class="author-avatar">
                <img src="https://sdn.geekzu.org/avatar/d22eb460ecab37fcd7205e6a3c55c228?s=200&r=X&d=" alt="木偶人" />
            </figure>
        
            <div class="author-info">
                <h4>木偶人</h4>
                <p>...</p>
            </div>
        </section>
    
    </div>
</main>

    <footer>
    <div class="buttons">
        <a class="to-top" href="#"></a>
    </div>
    <div class="wrap min">
        <section class="widget">
            <div class="row">
                <div class="col-m-4">
                    <h3 class="title-recent">最新文章：</h3>
                    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2023/12/22/cpp/c++11/%E5%B0%8F%E5%B0%8F%E7%9A%84operator-%E7%AB%9F%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%9A%E7%BB%86%E8%8A%82/">小小的operator=竟有这么多细节</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/12/19/vector/">自己实现STL之vector</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/12/18/std-allocator/">std::allocator堆内存管理器</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/12/12/FFmpeg/ffplay%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/decoder-decode-frame/">FFplay源码分析---decoder_decode_frame()</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/12/12/FFmpeg/ffplay%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/audio-thread/">FFplay源码分析---audio_thread()</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/12/11/FFmpeg/ffplay%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/audio-open/">FFplay源码分析---audio_open()</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-date">时光机：</h3>
                    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-tags">标签云：</h3>
                    <a href="/tags/FFmpeg/" style="font-size: 16px;">FFmpeg</a> <a href="/tags/FFplay%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 16px;">FFplay源码分析</a> <a href="/tags/c/" style="font-size: 12px;">c++</a> <a href="/tags/c-11/" style="font-size: 14px;">c++11</a> <a href="/tags/c-17/" style="font-size: 10px;">c++17</a> <a href="/tags/c-20/" style="font-size: 10px;">c++20</a> <a href="/tags/error/" style="font-size: 12px;">error</a> <a href="/tags/leetcode/" style="font-size: 18px;">leetcode</a> <a href="/tags/muduo/" style="font-size: 10px;">muduo</a> <a href="/tags/my-stl/" style="font-size: 10px;">my_stl</a> <a href="/tags/plan/" style="font-size: 10px;">plan</a> <a href="/tags/sylar/" style="font-size: 20px;">sylar</a> <a href="/tags/vscode/" style="font-size: 10px;">vscode</a> <a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">测试</a>
                </div>
            </div>
        </section>
        <section class="sub-footer">
            <p>© 2023 <a href="/">木偶人</a>. All Rights Reserved. Theme By <a href="https://github.com/Dreamer-Paul/Hingle" target="_blank" rel="nofollow">Hingle</a>.</p>
        </section>
    </div>
</footer>


<script src="/static/kico.js"></script>
<script src="/static/hingle.js"></script>


<script>var hingle = new Paul_Hingle({"copyright":true,"night":true});</script>

  </body>
</html>
