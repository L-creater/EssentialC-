<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        FFplay源码分析---decoder_decode_frame() - undefined
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>

    









<meta name="generator" content="Hexo 6.3.0"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>木偶人</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>收藏</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#decoder-decode-frame"><span class="toc-text">decoder_decode_frame()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0%E5%88%86%E6%9E%90"><span class="toc-text">函数参数分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-text">流程图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%A6%82%E4%B8%8B"><span class="toc-text">函数如下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA-do-while"><span class="toc-text">第一个 do while</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E4%B8%AA-do-while"><span class="toc-text">第二个 do while</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%B7%E6%96%B0%E7%BC%93%E5%AD%98"><span class="toc-text">刷新缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#avcodec-send-packet"><span class="toc-text">avcodec_send_packet()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#avcodec-receive-frame"><span class="toc-text">avcodec_receive_frame()</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        FFplay源码分析---decoder_decode_frame()
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2023-12-12 22:44:54</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#FFplay源码分析" title="FFplay源码分析">FFplay源码分析</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h2 id="decoder-decode-frame"><a href="#decoder-decode-frame" class="headerlink" title="decoder_decode_frame()"></a>decoder_decode_frame()</h2><p><img src="/../../../images/FFmpeg/ffplay%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/decoder_decode_frame().png" alt="Alt text"><br><code>decoder_decode_frame()</code> 其实是一个通用的解码函数，可以解码 音频，视频，字幕的 AVPacket。不过本文主要侧重于分析音频流的解码，但其他的流也是类似的逻辑。</p>
<h3 id="函数参数分析"><a href="#函数参数分析" class="headerlink" title="函数参数分析"></a>函数参数分析</h3><ol>
<li><p><code>Decoder *d</code>，这个 <code>Decoder</code> 结构，我把它称为解码管理实例。由于 <code>Decoder</code> 结构里面有解码器实例 跟 <code>PacketQueue</code> 队列，所以只需要传递 <code>Decoder</code> 给<code>decoder_decode_frame()</code> 函数就能进行解码了。如下：</p>
 <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Decoder</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    PacketQueue <span class="token operator">*</span>queue<span class="token punctuation">;</span> <span class="token comment">// AVPacket 队列</span>
    AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">;</span> <span class="token comment">//解码器实例</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span> Decoder<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>AVFrame *frame</code> ，用来存储解码出来的音频或者视频的 <code>AVFrame</code>。</p>
</li>
<li><p><code>AVSubtitle *sub</code> ，用来存储解码出来的字幕数据，字幕流的使用的数据结构不是 <code>AVFrame</code>，而是 <code>AVSubtitle</code> 。</p>
</li>
</ol>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><p><img src="/../../../images/FFmpeg/ffplay%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/decoder_decode_frame()%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="Alt text"></p>
<h3 id="函数如下"><a href="#函数如下" class="headerlink" title="函数如下"></a>函数如下</h3><p><strong>一个for循环结束</strong>————————</p>
<p>两个<code>do while</code></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">decoder_decode_frame</span><span class="token punctuation">(</span>Decoder <span class="token operator">*</span>d<span class="token punctuation">,</span> AVFrame <span class="token operator">*</span>frame<span class="token punctuation">,</span> AVSubtitle <span class="token operator">*</span>sub<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// if---因为已经跳转到别的时间播放了，解码器的缓存是以前的时间点缓存的。如果还继续取，窗口画面就有短暂的不准确。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>queue<span class="token operator">-></span>serial <span class="token operator">==</span> d<span class="token operator">-></span>pkt_serial<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 第一次，必然会跳出此循环</span>
            <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>queue<span class="token operator">-></span>abort_request<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

                <span class="token keyword">switch</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token operator">-></span>codec_type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">case</span> AVMEDIA_TYPE_VIDEO<span class="token operator">:</span>
                        <span class="token comment">// 第一次时，必然返回 `EAGAIN` </span>
                        <span class="token comment">// 后面调用时,仍然可能还是会返回`EAGAIN`，因为不是往解码器发一个`AVPacket`，就一定有数据可读的。有些是 B 帧，还需要多一个P帧来解码。</span>
                        ret <span class="token operator">=</span> <span class="token function">avcodec_receive_frame</span><span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>decoder_reorder_pts <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                frame<span class="token operator">-></span>pts <span class="token operator">=</span> frame<span class="token operator">-></span>best_effort_timestamp<span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>decoder_reorder_pts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                frame<span class="token operator">-></span>pts <span class="token operator">=</span> frame<span class="token operator">-></span>pkt_dts<span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> AVMEDIA_TYPE_AUDIO<span class="token operator">:</span>
                        <span class="token comment">// 第一次时，必然返回 `EAGAIN` </span>
                        ret <span class="token operator">=</span> <span class="token function">avcodec_receive_frame</span><span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            AVRational tb <span class="token operator">=</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> frame<span class="token operator">-></span>sample_rate<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token operator">-></span>pts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span>
                                frame<span class="token operator">-></span>pts <span class="token operator">=</span> <span class="token function">av_rescale_q</span><span class="token punctuation">(</span>frame<span class="token operator">-></span>pts<span class="token punctuation">,</span> d<span class="token operator">-></span>avctx<span class="token operator">-></span>pkt_timebase<span class="token punctuation">,</span> tb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>next_pts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span>
                                frame<span class="token operator">-></span>pts <span class="token operator">=</span> <span class="token function">av_rescale_q</span><span class="token punctuation">(</span>d<span class="token operator">-></span>next_pts<span class="token punctuation">,</span> d<span class="token operator">-></span>next_pts_tb<span class="token punctuation">,</span> tb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token operator">-></span>pts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                d<span class="token operator">-></span>next_pts <span class="token operator">=</span> frame<span class="token operator">-></span>pts <span class="token operator">+</span> frame<span class="token operator">-></span>nb_samples<span class="token punctuation">;</span>
                                d<span class="token operator">-></span>next_pts_tb <span class="token operator">=</span> tb<span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> AVERROR_EOF<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    d<span class="token operator">-></span>finished <span class="token operator">=</span> d<span class="token operator">-></span>pkt_serial<span class="token punctuation">;</span>
                    <span class="token function">avcodec_flush_buffers</span><span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>queue<span class="token operator">-></span>nb_packets <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment">// 唤醒read_thread线程</span>
                <span class="token function">SDL_CondSignal</span><span class="token punctuation">(</span>d<span class="token operator">-></span>empty_queue_cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>packet_pending<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                d<span class="token operator">-></span>packet_pending <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">int</span> old_serial <span class="token operator">=</span> d<span class="token operator">-></span>pkt_serial<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">packet_queue_get</span><span class="token punctuation">(</span>d<span class="token operator">-></span>queue<span class="token punctuation">,</span> d<span class="token operator">-></span>pkt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>d<span class="token operator">-></span>pkt_serial<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token comment">// 清空解码器缓存,从队列取出来的 AVPacket 跟上一次取的 AVPacket 序列号不一样，就会刷新解码器的缓存。</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>old_serial <span class="token operator">!=</span> d<span class="token operator">-></span>pkt_serial<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">avcodec_flush_buffers</span><span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    d<span class="token operator">-></span>finished <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    d<span class="token operator">-></span>next_pts <span class="token operator">=</span> d<span class="token operator">-></span>start_pts<span class="token punctuation">;</span>
                    d<span class="token operator">-></span>next_pts_tb <span class="token operator">=</span> d<span class="token operator">-></span>start_pts_tb<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// 如果不相等，就会直接 `av_packet_unref()` 释放，然后再进入 `while` 循环再从队列取`AVPacket`,快进时,丢弃数据.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>queue<span class="token operator">-></span>serial <span class="token operator">==</span> d<span class="token operator">-></span>pkt_serial<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>d<span class="token operator">-></span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token operator">-></span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_SUBTITLE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> got_frame <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">avcodec_decode_subtitle2</span><span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token punctuation">,</span> sub<span class="token punctuation">,</span> <span class="token operator">&amp;</span>got_frame<span class="token punctuation">,</span> d<span class="token operator">-></span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>got_frame <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>d<span class="token operator">-></span>pkt<span class="token operator">-></span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 发送解码器失败，把AVPacket缓存起来，下次继续发送。</span>
                    d<span class="token operator">-></span>packet_pending <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                ret <span class="token operator">=</span> got_frame <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>pkt<span class="token operator">-></span>data <span class="token operator">?</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span> <span class="token operator">:</span> AVERROR_EOF<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>d<span class="token operator">-></span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avcodec_send_packet</span><span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token punctuation">,</span> d<span class="token operator">-></span>pkt<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">av_log</span><span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token punctuation">,</span> AV_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"Receive_frame and send_packet both returned EAGAIN, which is an API violation.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 发送解码器失败，把AVPacket缓存起来，下次继续发送。</span>
                d<span class="token operator">-></span>packet_pending <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>d<span class="token operator">-></span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="第一个-do-while"><a href="#第一个-do-while" class="headerlink" title="第一个 do while"></a>第一个 <code>do while</code></h3><p>一开始就会用 <code>avcodec_receive_frame()</code>去解码器读数据，这里读者可能会有疑问，明明都还没往解码器发送 <code>AVPacket</code>， <code>avcodec_receive_frame()</code> 函数怎么可能读取到 <code>AVFrame</code> 呢？</p>
<p>答：没错，就是读取不到，因为还没发 <code>AVPacket</code> 给解码器解码。所以，首次 <code>avcodec_receive_frame()</code>必然返回 <code>EAGAIN</code>，所以就会跳出这个<code>do&#123;&#125;while&#123;&#125;</code> 循环。</p>
<h3 id="第二个-do-while"><a href="#第二个-do-while" class="headerlink" title="第二个 do while"></a>第二个 <code>do while</code></h3><ol>
<li><p><code>SDL_CondSignal(d-&gt;empty_queue_cond)</code>，首先，如果 <code>PacketQueue</code> 队列里面如果没有数据可读了，就需要唤醒<code>read_thread()</code> 线程来读数据，之前说过， <code>empty_queue_cond</code> 实际上就是 <code>continue_read_thread</code>，这两个指针都指向同一个条件变量。</p>
</li>
<li><p>判断之前发送 <code>AVPacket</code> 给解码器是否失败了？如果失败，<code>d-&gt;packet_peding</code> 会是 1。如果上次失败了，<code>d-&gt;pkt</code>本身就是有值的，就不需要重队列里面拿数据，直接把<code>d-&gt;pkt</code> 发送给解码器即可。</p>
</li>
<li><p>调用 <code>packet_queue_get()</code> 从 队列读取 AVPacket。简单讲解一下 <code>packet_queue_get()</code> 函数的参数，定义如下：</p>
<ul>
<li><code>int block</code> 是控制 <code>packet_queue_get()</code> 函数阻塞读取的，如果 <code>PacketQueue</code> 队列里面如果没有数据可读，可以一直阻塞等到 <code>read_thread()</code>线程读到数据放进去队列 为止。</li>
<li><code>AVPacket *pkt</code>，用来放从队列读取到的 <code>AVPacket。</code></li>
<li><code>int *serial</code>，读取到的 <code>AVPacket</code> 的序列号，这是一个返回值。传的是指针。</li>
</ul>
</li>
</ol>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">packet_queue_get</span><span class="token punctuation">(</span>PacketQueue <span class="token operator">*</span>q<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">,</span> <span class="token keyword">int</span> block<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>serial<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>PacketQueue</code> 队列是一个 <code>FIFO</code> 的内存管理器，存的是 <code>MyAVPacketList</code>，如下：<br>也就是说，队列里的每一个 <code>AVPacket</code> 都有一个序列号的。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">MyAVPacketList</span> <span class="token punctuation">&#123;</span>
    AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">;</span>
    <span class="token keyword">int</span> serial<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> MyAVPacketList<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>再回到<code>decoder_decode_frame()</code>调用 <code>packet_queue_get()</code> 时的传参，如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> old_serial <span class="token operator">=</span> d<span class="token operator">-></span>pkt_serial<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">packet_queue_get</span><span class="token punctuation">(</span>d<span class="token operator">-></span>queue<span class="token punctuation">,</span> d<span class="token operator">-></span>pkt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>d<span class="token operator">-></span>pkt_serial<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>可以看到从队列取出来的 <code>AVPacket</code> 就放在 <code>d-&gt;pkt</code>里面，而序列号就放在<code>d-&gt;pkt_serial</code>。<br>FFplay播放器其实有 3 种序列号：</p>
<ol>
<li><p><code>MyAVPacketList</code> 的 <code>serial</code> ，队列里面的 <code>AVPacket</code> 的序列号。可以看成是临时值，旧值。</p>
</li>
<li><p><code>PackeQueue</code> 的 <code>serial</code> ，这是队列本身的序列号。可以看成是最新的序列号的值。</p>
</li>
<li><p><code>Frame</code> 的 <code>serial</code>，本文不需要关注这个, todo — 序列号分析</p>
</li>
</ol>
<p><code>MyAVPacketList</code> 的 <code>serial</code> 就是用<code>PackeQueue</code> 队列的 <code>serial</code> 来赋值的 。如下代码：<strong>只要不进行跳转播放，他们的序列号就是一样的。</strong></p>
<p>当快进快退，或者跳转播放时间点的时候，<code>PackeQueue</code>队列的序列号就会 +1，而之前已经放进去队列的 <code>MyAVPacketList</code> 的序列号则保持不变。</p>
<p><strong>举个例子</strong>，当前MP4已经播放到了 第20秒的时刻，此时 <code>PackeQueue</code> 队列缓存了 5 帧第 21秒的数据，此时，我快进30秒，跳转到第 50 秒的时刻播放。</p>
<p>由于跳转了，所以队列的序列号会 +1，变成了 2，而之前的 5 帧 <code>MyAVPacketList</code> 的序列号还是 1。两者就会不一样。</p>
<p>因为要开始播放第 50 秒的数据，所以 <code>PackeQueue</code> 队列之前缓存的 5 帧数据就不可用了。丢弃这 5 帧数据就是由下面的代码实现的。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>queue<span class="token operator">-></span>serial <span class="token operator">==</span> d<span class="token operator">-></span>pkt_serial<span class="token punctuation">)</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token function">av_packet_unref</span><span class="token punctuation">(</span>d<span class="token operator">-></span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>注意看上面圈出来的代码，只有两者相等，才会 <code>break</code> 退出，如果不相等，就会直接 <code>av_packet_unref()</code> 释放，然后再进入 <code>while</code> 循环再从队列取<code>AVPacket</code>。</p>
<p>这样，就能把无效的 5 帧数据全部丢弃，直到从队列读取到序列号一致的 <code>AVPacket</code> 为止。</p>
<h3 id="刷新缓存"><a href="#刷新缓存" class="headerlink" title="刷新缓存"></a>刷新缓存</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>old_serial <span class="token operator">!=</span> d<span class="token operator">-></span>pkt_serial<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">avcodec_flush_buffers</span><span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    d<span class="token operator">-></span>finished <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    d<span class="token operator">-></span>next_pts <span class="token operator">=</span> d<span class="token operator">-></span>start_pts<span class="token punctuation">;</span>
    d<span class="token operator">-></span>next_pts_tb <span class="token operator">=</span> d<span class="token operator">-></span>start_pts_tb<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>就是当从队列取出来的 <code>AVPacket</code> 跟上一次取的 <code>AVPacket</code> 序列号不一样，就会刷新解码器的缓存。</p>
<p>序列号不一样，肯定是因为跳转了播放时间点，而解码器要按顺序解码的，如果不清空缓存，可能会导致马赛克。</p>
<h3 id="avcodec-send-packet"><a href="#avcodec-send-packet" class="headerlink" title="avcodec_send_packet()"></a>avcodec_send_packet()</h3><p>假设现在已经从队列读取到 序列号跟队列一样的<code>AVPacket</code>，就会把 <code>AVPacket</code> 发送给解码器，如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avcodec_send_packet</span><span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token punctuation">,</span> d<span class="token operator">-></span>pkt<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token punctuation">,</span> AV_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"Receive_frame and send_packet both returned EAGAIN, which is an API violation.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d<span class="token operator">-></span>packet_pending <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>d<span class="token operator">-></span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由于发送解码器可能会失败，所以 <code>ffplay</code> 做了一下处理，如果失败，就不<code>unref</code>，直接标记一下 <code>d-&gt;packet_pending</code>，下次再继续发送。</p>
<hr>
<p>此时，已经成功发送 <code>AVPacket</code> 给解码器了。这时候，<code>decoder_decode_frame()</code> 还没有结束，此时此刻还没跳出 最开始的 <code>for (;;) &#123;&#125;</code> 循环。</p>
<p>所以又会重新进入一开始的往解码器读 <code>AVFrame</code> 的逻辑，<code>decoder_decode_frame()</code>函数的逻辑可以说是反着来的，所以看起来有点奇怪。</p>
<p>现在回到一开始的逻辑，如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// if---因为已经跳转到别的时间播放了，解码器的缓存是以前的时间点缓存的。如果还继续取，窗口画面就有短暂的不准确。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>queue<span class="token operator">-></span>serial <span class="token operator">==</span> d<span class="token operator">-></span>pkt_serial<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>queue<span class="token operator">-></span>abort_request<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

                <span class="token keyword">switch</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token operator">-></span>codec_type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">case</span> AVMEDIA_TYPE_VIDEO<span class="token operator">:</span>
                    <span class="token comment">// 仍然可能还是会返回`EAGAIN`，因为不是往解码器发一个`AVPacket`，就一定有数据可读的。有些是 B 帧，还需要多一个P帧来解码。</span>
                        ret <span class="token operator">=</span> <span class="token function">avcodec_receive_frame</span><span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>decoder_reorder_pts <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                frame<span class="token operator">-></span>pts <span class="token operator">=</span> frame<span class="token operator">-></span>best_effort_timestamp<span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>decoder_reorder_pts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                frame<span class="token operator">-></span>pts <span class="token operator">=</span> frame<span class="token operator">-></span>pkt_dts<span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> AVMEDIA_TYPE_AUDIO<span class="token operator">:</span>
                        ret <span class="token operator">=</span> <span class="token function">avcodec_receive_frame</span><span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            AVRational tb <span class="token operator">=</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> frame<span class="token operator">-></span>sample_rate<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token operator">-></span>pts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span>
                                frame<span class="token operator">-></span>pts <span class="token operator">=</span> <span class="token function">av_rescale_q</span><span class="token punctuation">(</span>frame<span class="token operator">-></span>pts<span class="token punctuation">,</span> d<span class="token operator">-></span>avctx<span class="token operator">-></span>pkt_timebase<span class="token punctuation">,</span> tb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>next_pts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span>
                                frame<span class="token operator">-></span>pts <span class="token operator">=</span> <span class="token function">av_rescale_q</span><span class="token punctuation">(</span>d<span class="token operator">-></span>next_pts<span class="token punctuation">,</span> d<span class="token operator">-></span>next_pts_tb<span class="token punctuation">,</span> tb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token operator">-></span>pts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                d<span class="token operator">-></span>next_pts <span class="token operator">=</span> frame<span class="token operator">-></span>pts <span class="token operator">+</span> frame<span class="token operator">-></span>nb_samples<span class="token punctuation">;</span>
                                d<span class="token operator">-></span>next_pts_tb <span class="token operator">=</span> tb<span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> AVERROR_EOF<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    d<span class="token operator">-></span>finished <span class="token operator">=</span> d<span class="token operator">-></span>pkt_serial<span class="token punctuation">;</span>
                    <span class="token function">avcodec_flush_buffers</span><span class="token punctuation">(</span>d<span class="token operator">-></span>avctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="avcodec-receive-frame"><a href="#avcodec-receive-frame" class="headerlink" title="avcodec_receive_frame()"></a>avcodec_receive_frame()</h3><p><code>avcodec_receive_frame()</code> 仍然可能还是会返回<code>EAGAIN</code>，因为不是往解码器发一个<code>AVPacket</code>，就一定有数据可读的。有些是 B 帧，还需要多一个P帧来解码。所以如果 <code>avcodec_receive_frame()</code> 返回 <code>EAGAIN</code>，就会从 <code>PacketQueue</code> 队列再拿出一个 <code>AVPacket</code> 往解码器丢。</p>
<p>现在我们假设<code>avcodec_receive_frame()</code> 能读出数据了，可以看到，它赋值给了参数 <code>frame</code>，也就是第二个参数。</p>
<p>读到 <code>AVFrame</code> 之后，<code>decoder_decode_frame()</code>就会直接 <code>return 1</code> 退出了。</p>
<p>注意，<code>decoder_decode_frame()</code> 只从解码器读取到一个 <code>AVFrame</code> 就返回了，如果解码器里面还有缓存的<code>AVFrame</code>，下次就可以直接取，而不用再从队列拿 <code>AVPacket</code> 再发送给解码器。</p>
<p><strong>这就是为什么从解码器读 AVFrame 要加上这个 if 判断：</strong></p>
<p>因为已经跳转到别的时间播放了，解码器的缓存是以前的时间点缓存的。如果还继续取，窗口画面就有短暂的不准确。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">

<span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>queue<span class="token operator">-></span>serial <span class="token operator">==</span> d<span class="token operator">-></span>pkt_serial<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p>总结:</p>
<p><code>decoder_decode_frame()</code> 函数的逻辑就是从解码器读取到 一个<code>AVFrame</code>，为了解码出一个<code>AVFrame</code>，它会从 <code>PacketQueue</code> 队列取 <code>AVPacekt</code> 发送给解码器，需要多少个就取多少个 <code>AVPacekt</code>，直至到能解码出一个 <code>AVFrame。</code></p>
<p><code>decoder_decode_frame()</code> 函数有 3 个返回值:</p>
<ul>
<li>返回 1，获取到 <code>AVFrame</code> 。</li>
<li>返回 0 ，获取不到 <code>AVFrame</code> ，0 代表已经解码完<code>MP4</code>的所有<code>AVPacket</code>。这种情况一般是 <code>ffplay</code> 播放完了整个 <code>MP4</code> 文件，窗口画面停在最后一帧。但是由于你可以按<code>C</code> 键重新循环播放，所以即便返回 0 也不能退出 <code>audio_thread</code> 线程。</li>
<li>返回 -1，代表 <code>PacketQueue</code> 队列关闭了<code>(abort_request)</code>。返回 -1 会导致 <code>audio_thread()</code> 函数用 <code>goto the_end</code> 跳出 <code>do&#123;&#125;whlle&#123;&#125;</code> 循环，跳出循环之后，<code>audio_thread</code> 线程就会自己结束了。返回<code>-1</code> 通常是因为关闭了 <code>ffplay</code> 播放器。</li>
</ul>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/lyt-s">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href=""></a></span>
        <span>/</span>
        
        <span><a href="https://lyt-s.github.io/">木偶人</a></span>
        <span>/</span>
        
        <span><a href="#">It helps SEO</a></span>
        <span>/</span>
        
        <span><a href=""></a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://giscus.app/client.js"
    data-repo="aircloud/hexo-aircloud-blog"
    data-repo-id="MDEwOlJlcG9zaXRvcnkxMjkwNDgyNjg="
    data-category="Announcements"
    data-category-id="DIC_kwDOB7EezM4COhKJ"
    data-mapping="title"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="light"
    data-lang="zh-CN"
    crossorigin="anonymous"
    async>
</script>




</html>
